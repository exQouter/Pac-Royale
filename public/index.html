<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pac-Royale Battle</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { 
            margin: 0; background: #050505; color: white; font-family: 'Press Start 2P'; 
            display: flex; flex-direction: row; justify-content: center; align-items: flex-start;
            height: 100vh; width: 100vw; overflow: hidden; 
            user-select: none; touch-action: none; overscroll-behavior: none; position: fixed;
            padding-top: 40px; box-sizing: border-box;
        }

        canvas { 
            border: 6px solid #1919A6; background: black; image-rendering: pixelated; 
            box-shadow: 0 0 40px rgba(25,25,166,0.4); 
            display: none; 
            height: auto; width: auto; max-width: 100%; max-height: calc(100vh - 60px);
            aspect-ratio: 3/4; object-fit: contain;
            position: relative; z-index: 10;
        }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: none; justify-content: center;
        }

        .side-panel { 
            width: 140px; height: 160px; 
            background: #000; border: 4px solid var(--p-color); 
            padding: 10px; display: flex; flex-direction: column; align-items: center; 
            justify-content: center; text-align: center; opacity: 0.3; 
            transition: opacity 0.3s, transform 0.2s, box-shadow 0.2s; 
            box-shadow: 6px 6px 0px color-mix(in srgb, var(--p-color), black 50%); 
            position: absolute; pointer-events: auto;
        }
        .side-panel.active { opacity: 1; transform: translate(-2px, -2px); box-shadow: 8px 8px 0px color-mix(in srgb, var(--p-color), black 50%); }

        #p0 { top: 40px;  left: calc(50% - 300px - 15px - 170px); }
        #p2 { top: 260px; left: calc(50% - 300px - 15px - 170px); }
        #p1 { top: 40px;  right: calc(50% - 300px - 15px - 170px); }
        #p3 { top: 260px; right: calc(50% - 300px - 15px - 170px); }

        .pac-avatar { width: 40px; height: 40px; border-radius: 50%; margin-bottom: 15px; background: conic-gradient(transparent 30deg, var(--p-color) 30deg 330deg, transparent 330deg); transform: rotate(90deg); border: none; box-shadow: none; }
        .player-name-ui { font-size: 10px; margin-bottom: 10px; color: var(--p-color); text-transform: uppercase; font-weight: bold; letter-spacing: 1px; background: transparent; padding: 0; width: 100%; padding-bottom: 5px; text-shadow: 2px 2px 0px color-mix(in srgb, var(--p-color), black 60%); }
        .stat-label { font-size: 7px; color: #888; margin-top: 10px; margin-bottom: 5px; letter-spacing: 1px; }
        .score-box { font-size: 10px; color: #fff; }
        .lives-box { color: #ff3333; letter-spacing: 2px; font-size: 12px; margin-top: 5px; }

        .screen { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: #000; padding: 40px; border: 4px solid #ffcc00; z-index: 100; min-width: 300px; max-width: 90%; box-shadow: 10px 10px 0px rgba(0,0,0,0.8); display: none; box-sizing: border-box; }
        .visible { display: block !important; }
        #countdown-display { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 100px; color: #ffcc00; text-shadow: 5px 5px 0 #000; z-index: 50; pointer-events: none; display: none; }
        button { background: #ffcc00; padding: 15px; font-family: inherit; cursor: pointer; border: 2px solid white; margin-top: 15px; text-transform: uppercase; box-shadow: 4px 4px 0 #b8860b; width: 100%; font-weight: bold; font-size: 12px; box-sizing: border-box; }
        button:hover { transform: translate(-1px, -1px); background: #ffe066; }
        button:active { transform: translate(1px, 1px); box-shadow: 2px 2px 0 #b8860b; }
        button:disabled { background: #555; color: #999; cursor: not-allowed; box-shadow: none; transform: none; border-color: #777; }
        input { background: #111; border: 2px solid #555; color: #ffcc00; font-family: inherit; padding: 15px; text-align: center; text-transform: uppercase; font-size: 16px; display: block; margin: 10px auto; width: 80%; box-sizing: border-box; }
        
        .menu-grid { display: grid; grid-template-columns: 1fr 2px 1fr; gap: 20px; margin-top: 20px; align-items: stretch; } 
        .menu-col { display: flex; flex-direction: column; gap: 10px; justify-content: space-between; }
        .menu-divider { background: #333; height: 100%; min-height: 150px; }
        .menu-label { font-size: 10px; color: #888; margin-bottom: 5px; text-align: center; }
        
        .lobby-container { display: flex; gap: 15px; justify-content: center; margin: 30px 0; flex-wrap: wrap; }
        .lobby-slot { width: 110px; height: 130px; border: 4px solid #333; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .lobby-slot.filled { border-color: #fff; background: #111; }
        .slot-label { font-size: 8px; color: #666; position: absolute; top: 5px; }
        .slot-name { font-size: 10px; color: #fff; margin-top: 10px; word-break: break-all; }
        .slot-pacman { width: 40px; height: 40px; border-radius: 50%; position: relative; background: conic-gradient(transparent 30deg, var(--slot-color) 30deg 330deg, transparent 330deg); transform: rotate(90deg); box-shadow: none; }
        .waiting-anim { font-size: 8px; color: #444; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        .lobby-code { font-size: 24px; color: #00FFFF; margin: 10px 0; cursor: pointer; border: 1px dashed #444; padding: 10px; }
        .error-msg { color: red; font-size: 10px; margin-top: 15px; text-align: center; }
        #scoreboard-btn { background: #444; color: white; font-size: 10px; width: 200px; margin: 20px auto; border-color: #666; box-shadow: none; display: block; }
        .match-leaderboard { width: 100%; margin: 20px 0; border-collapse: separate; border-spacing: 0 5px; }
        .leader-row { background: #222; }
        .leader-row td { padding: 10px; font-size: 10px; }
        .leader-row.first-place { border: 2px solid #FFD700; background: #333; box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
        .match-stats { display: flex; justify-content: center; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #444; flex-wrap: wrap; max-width: 500px; margin-left: auto; margin-right: auto;}
        .stat-item { display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 9px; color: #aaa; width: 50px; margin-bottom: 10px; }
        .icon-svg { width: 25px; height: 25px; display: block; }
        
        .game-over-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 30px; flex-wrap: wrap; }
        .btn-spectate { background: #555; border-color: #777; color: white; }
        .btn-play-again { background: #00FF00; color: black; border-color: #fff; }
        .btn-main-menu { background: #FF0000; color: white; border-color: #fff; }

        #spectator-menu-btn { display: none; position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); width: auto; margin: 0; padding: 12px 25px; background: rgba(0, 0, 0, 0.8); color: #FFD700; border: 2px solid #FFD700; box-shadow: 0 0 10px rgba(0,0,0,0.5); font-size: 12px; z-index: 150; border-radius: 4px; }
        
        .color-picker { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
        .color-swatch { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #333; cursor: pointer; transition: transform 0.1s; }
        .color-swatch:hover { transform: scale(1.2); border-color: #fff; }
        .color-swatch.disabled { opacity: 0.2; cursor: not-allowed; transform: none; border-color: #333; }

        #mute-btn { position: fixed; bottom: 40px; right: 20px; background: transparent; color: #555; border: none; opacity: 0.5; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; padding: 0; display: none; z-index: 200; align-items: center; justify-content: center; outline: none; box-shadow: none;}
        #mute-btn:hover { color: white; opacity: 1; transform: scale(1.1); text-shadow: 0 0 5px #fff; }

        @media (max-width: 900px) {
            body { flex-direction: column; justify-content: flex-start; align-items: stretch; padding-top: 0; }
            canvas { flex-grow: 0; width: auto; height: auto; max-width: 100%; max-height: calc(100vh - 70px); margin: 5px auto; border: 6px solid #1919A6; box-sizing: border-box; order: 2; }
            #ui-layer { position: relative; width: 100%; height: 60px; background: #000; border-bottom: 2px solid #333; pointer-events: auto; order: 1; flex-direction: row; justify-content: space-evenly; align-items: center; padding: 0; }
            .side-panel { position: relative; top: auto !important; left: auto !important; right: auto !important; width: 22%; height: 100%; border: none; border-bottom: 4px solid var(--p-color); box-shadow: none !important; background: transparent; padding: 2px; order: var(--order); }
            .side-panel.active { background: rgba(255,255,255,0.1); }
            .pac-avatar, .stat-label { display: none; }
            .player-name-ui { font-size: 8px; margin: 2px 0; }
            .score-box { font-size: 9px; font-weight: bold; }
            .lives-box { font-size: 8px; margin-top: 2px; }
            #mute-btn { top: 70px; right: 10px; bottom: auto; width: 30px; height: 30px; font-size: 16px; background: rgba(0,0,0,0.5); border-radius: 4px; }
            .menu-grid { grid-template-columns: 1fr; gap: 10px; }
            .menu-divider { height: 1px; width: 100%; min-height: 1px; }
            button { padding: 10px; font-size: 10px; margin-top: 5px; }
            input { padding: 10px; font-size: 12px; }
            h1 { font-size: 24px !important; margin-bottom: 20px !important; }
            .screen { padding: 15px; min-width: 0 !important; width: 90% !important; max-width: 95% !important; }
            #lobby-screen { min-width: 0 !important; }
            .lobby-container { gap: 5px; }
            .lobby-slot { width: 85px; height: 100px; border-width: 2px; }
            .slot-pacman { width: 30px; height: 30px; }
            .slot-name { font-size: 8px; }
            .lobby-code { font-size: 16px; padding: 5px; }
            #game-over { min-width: 0 !important; }
            #game-over h1 { font-size: 20px !important; margin-bottom: 5px; }
            .match-leaderboard td { padding: 5px; font-size: 8px; }
            .stat-item { width: 40px; font-size: 8px; }
            .icon-svg { width: 20px; height: 20px; }
            .game-over-buttons { margin-top: 15px; gap: 5px; }
            .btn-spectate, .btn-play-again, .btn-main-menu { padding: 8px; font-size: 9px; width: 100%; margin-top: 5px; }
        }
    </style>
</head>
<body>
    <div id="intro-screen" class="screen visible">
        <h1 style="color:#ffcc00; margin-bottom:40px; text-shadow: 4px 4px 0 #b8860b;">PAC-ROYALE</h1>
        <p style="font-size:10px; color:#aaa; margin-bottom:20px;">ONLINE BATTLE</p>
        <button style="width: 200px; margin: 0 auto; display: block;" onclick="enterMenu()">PLAY</button>
        <button id="scoreboard-btn" onclick="toggleBoard(); uiClick()">üèÜ SCOREBOARD</button>
    </div>
    <div id="menu-screen" class="screen">
        <h2 style="color:#ffcc00; margin-bottom:10px;">SETUP PROFILE</h2>
        <div style="width: 80%; margin: 0 auto;"><input type="text" id="nickname" placeholder="ENTER NICKNAME" maxlength="10"></div>
        <div class="menu-grid">
            <div class="menu-col"><div class="menu-label">NEW GAME</div><button onclick="createLobby(); uiClick()">CREATE LOBBY</button></div>
            <div class="menu-divider"></div>
            <div class="menu-col"><div class="menu-label">EXISTING GAME</div><div style="display: flex; flex-direction: column; gap: 5px; width: 100%;"><input type="text" id="lobby-code-input" placeholder="CODE" maxlength="5" style="width: 100%;"><button onclick="joinLobby(); uiClick()">JOIN</button></div></div>
        </div>
        <div id="menu-error" class="error-msg"></div>
        <button style="background: #444; border-color: #666; margin-top:30px; width:auto;" onclick="backToIntro(); uiClick()">BACK</button>
    </div>
    <div id="lobby-screen" class="screen" style="min-width: 600px; max-width: 95vw;">
        <h2 style="font-size:16px; color:#aaa;">LOBBY ROOM</h2>
        <div class="lobby-code" id="lobby-code-display" onclick="copyLink(); uiClick()">CODE: ????</div>
        <div style="margin-top: 10px; font-size: 10px; color: #ccc;">CHOOSE COLOR:</div>
        <div class="color-picker" id="color-picker-container">
            <div class="color-swatch" data-idx="0" style="background: #FFFF00;" onclick="selectColor(0)"></div>
            <div class="color-swatch" data-idx="1" style="background: #00FF00;" onclick="selectColor(1)"></div>
            <div class="color-swatch" data-idx="2" style="background: #BF00FF;" onclick="selectColor(2)"></div>
            <div class="color-swatch" data-idx="3" style="background: #0055FF;" onclick="selectColor(3)"></div>
        </div>
        <div class="lobby-container">
            <div class="lobby-slot" id="slot-0"><div class="slot-label">PLAYER 1</div><div class="waiting-anim">WAITING...</div></div>
            <div class="lobby-slot" id="slot-1"><div class="slot-label">PLAYER 2</div><div class="waiting-anim">WAITING...</div></div>
            <div class="lobby-slot" id="slot-2"><div class="slot-label">PLAYER 3</div><div class="waiting-anim">WAITING...</div></div>
            <div class="lobby-slot" id="slot-3"><div class="slot-label">PLAYER 4</div><div class="waiting-anim">WAITING...</div></div>
        </div>
        <div style="width: 50%; margin: 0 auto;"><button id="start-game-btn" onclick="startGame(); uiClick()" style="display:none; background:#00FF00; color:black;">START GAME</button></div>
        <div id="waiting-msg" style="font-size:10px; color:#FFFF00; margin-top:20px;">WAITING FOR HOST...</div>
    </div>
    <div id="board-screen" class="screen"><h1 style="color:#ffcc00;">TOP 10</h1><table id="board-table" style="width:100%; color:#ccc; font-size:10px; margin-top:20px;"></table><button onclick="toggleBoard(); uiClick()">CLOSE</button></div>
    <div id="countdown-display">3</div>
    
    <canvas id="gameCanvas" width="600" height="800"></canvas>
    
    <div id="ui-layer">
        <div class="side-panel" id="p0" style="--p-color:#FFFF00; --order:0;">
            <div class="pac-avatar"></div><div class="player-name-ui" id="n0">P1</div><div class="stat-label">SCORE</div><div class="score-box" id="s0">0</div><div class="stat-label">LIVES</div><div class="lives-box" id="l0">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        </div>
        <div class="side-panel" id="p1" style="--p-color:#00FF00; --order:1;">
            <div class="pac-avatar"></div><div class="player-name-ui" id="n1">P2</div><div class="stat-label">SCORE</div><div class="score-box" id="s1">0</div><div class="stat-label">LIVES</div><div class="lives-box" id="l1">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        </div>
        <div class="side-panel" id="p2" style="--p-color:#00FFFF; --order:2;">
            <div class="pac-avatar"></div><div class="player-name-ui" id="n2">P3</div><div class="stat-label">SCORE</div><div class="score-box" id="s2">0</div><div class="stat-label">LIVES</div><div class="lives-box" id="l2">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        </div>
        <div class="side-panel" id="p3" style="--p-color:#FF00FF; --order:3;">
            <div class="pac-avatar"></div><div class="player-name-ui" id="n3">P4</div><div class="stat-label">SCORE</div><div class="score-box" id="s3">0</div><div class="stat-label">LIVES</div><div class="lives-box" id="l3">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        </div>
    </div>
    
    <button id="mute-btn" onclick="toggleMute()">üîä</button>
    <div id="game-over" class="screen" style="min-width: 600px; max-width: 90vw;">
        <h1 style="color:red; margin-bottom: 10px;">GAME OVER</h1>
        <p id="final-score" style="color:white; font-size:14px; margin:5px 0;"></p>
        <div id="match-results-container"></div>
        <div id="match-stats-container" class="match-stats"></div>
        <div class="game-over-buttons" id="go-buttons"></div>
    </div>
    <div id="host-left-screen" class="screen" style="z-index:200;"><h1 style="color:red;">ROOM CLOSED</h1><button onclick="location.reload()" style="width: 200px; margin: 0 auto;">MENU</button></div>
    <button id="spectator-menu-btn" onclick="reopenGameOver(); uiClick()">SCORE</button>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const TILE_SIZE = 30;
        const urlParams = new URLSearchParams(window.location.search);
        const PLAYER_COLORS = ['#FFFF00', '#00FF00', '#BF00FF', '#0055FF'];
        let isJoined = false, isSpectating = false;
        let popups = [];
        let prevScore = 0;
        let lastAngles = {};
        let leaderboardData = []; 
        let deathZoneY = 1000;
        let localRows = {}; 
        let currState = null;

        window.onload = () => {
            const savedNick = localStorage.getItem('pac_royale_nickname');
            if (savedNick) document.getElementById('nickname').value = savedNick;
            document.addEventListener('dblclick', function(event) { event.preventDefault(); }, { passive: false });
        };

        // SWIPE CONTROL
        let touchStartX = 0;
        let touchStartY = 0;
        document.addEventListener('touchstart', function(e) { touchStartX = e.changedTouches[0].screenX; touchStartY = e.changedTouches[0].screenY; }, {passive: false});
        document.addEventListener('touchmove', function(e) { e.preventDefault(); }, {passive: false});
        document.addEventListener('touchend', function(e) { const touchEndX = e.changedTouches[0].screenX; const touchEndY = e.changedTouches[0].screenY; handleSwipe(touchEndX, touchEndY); }, {passive: false});
        function handleSwipe(endX, endY) {
            if(!isJoined) return;
            const diffX = endX - touchStartX;
            const diffY = endY - touchStartY;
            const threshold = 30; 
            if (Math.abs(diffX) > Math.abs(diffY)) { if (Math.abs(diffX) > threshold) sendInput({x: diffX > 0 ? 1 : -1, y: 0}); } 
            else { if (Math.abs(diffY) > threshold) sendInput({x: 0, y: diffY > 0 ? 1 : -1}); }
        }

        if(urlParams.has('code')) { document.getElementById('lobby-code-input').value = urlParams.get('code'); document.getElementById('intro-screen').classList.remove('visible'); document.getElementById('menu-screen').classList.add('visible'); }

        class PacmanSynth {
            constructor() { 
                this.ctx = new (window.AudioContext||window.webkitAudioContext)(); 
                this.masterGain = this.ctx.createGain(); 
                this.masterGain.gain.value = 0.15; 
                this.masterGain.connect(this.ctx.destination); 
                this.isMuted = false; 
                this.sirenOsc = null;
                this.evilInterval = null; 
            }
            resume() { if (this.ctx.state === 'suspended') this.ctx.resume(); }
            toggleMute() { this.isMuted = !this.isMuted; this.masterGain.gain.setValueAtTime(this.isMuted ? 0 : 0.15, this.ctx.currentTime); return this.isMuted; }
            createSoftOsc(type, freq, t) { if(this.isMuted) return {osc:{start:()=>{},stop:()=>{},connect:()=>{}}, gain:{gain:{setValueAtTime:()=>{},exponentialRampToValueAtTime:()=>{},linearRampToValueAtTime:()=>{}}}}; const o=this.ctx.createOscillator(); o.type=type; o.frequency.setValueAtTime(freq,t); const f=this.ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=1000; const g=this.ctx.createGain(); o.connect(f); f.connect(g); g.connect(this.masterGain); return {osc:o, gain:g}; }
            playClick() { if(this.isMuted) return; const t=this.ctx.currentTime; const {osc,gain}=this.createSoftOsc('square',800,t); gain.gain.setValueAtTime(0.1,t); gain.gain.exponentialRampToValueAtTime(0.01,t+0.1); osc.start(t); osc.stop(t+0.1); }
            playWaka() { if(this.isMuted) return; const t=this.ctx.currentTime; const o=this.ctx.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(150,t); o.frequency.linearRampToValueAtTime(50,t+0.15); const g=this.ctx.createGain(); g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.8,t+0.02); g.gain.linearRampToValueAtTime(0,t+0.15); o.connect(g); g.connect(this.masterGain); o.start(t); o.stop(t+0.15); }
            playEat() { if(this.isMuted) return; const t=this.ctx.currentTime; const {osc,gain}=this.createSoftOsc('square',300,t); osc.frequency.exponentialRampToValueAtTime(50,t+0.1); gain.gain.setValueAtTime(0.3,t); gain.gain.linearRampToValueAtTime(0,t+0.1); osc.start(t); osc.stop(t+0.1); }
            playDeath() { if(this.isMuted) return; this.stopSiren(); this.stopEvilTheme(); const t=this.ctx.currentTime; for(let i=0;i<8;i++){ const {osc,gain}=this.createSoftOsc('triangle',300-i*30,t+i*0.1); osc.frequency.linearRampToValueAtTime(50,t+i*0.1+0.1); gain.gain.setValueAtTime(0.3,t+i*0.1); gain.gain.linearRampToValueAtTime(0,t+i*0.1+0.1); osc.start(t+i*0.1); osc.stop(t+i*0.1+0.1); } }
            playIntro() { if(this.isMuted) return; const t=this.ctx.currentTime, notes=[246,493,369,311,493,369,311,493,369,311,246]; let time=t; notes.forEach(f=>{ const {osc,gain}=this.createSoftOsc('triangle',f,time); gain.gain.setValueAtTime(0.2,time); gain.gain.linearRampToValueAtTime(0,time+0.08); osc.start(time); osc.stop(time+0.1); time+=0.12; }); }
            startSiren(type) { if(this.isMuted || this.sirenOsc) return; const t=this.ctx.currentTime; this.sirenOsc=this.ctx.createOscillator(); this.sirenOsc.type=type==='power'?'triangle':'sine'; this.sirenOsc.frequency.setValueAtTime(type==='power'?300:150,t); const lfo=this.ctx.createOscillator(); lfo.frequency.value=type==='power'?5:1.5; const lg=this.ctx.createGain(); lg.gain.value=20; lfo.connect(lg); lg.connect(this.sirenOsc.frequency); lfo.start(t); const mg=this.ctx.createGain(); mg.gain.value=0.1; this.sirenOsc.connect(mg); mg.connect(this.masterGain); this.sirenOsc.start(t); this.sirenLFO=lfo; this.currentSirenType=type; }
            stopSiren() { if(this.sirenOsc){ try{this.sirenOsc.stop(); if(this.sirenLFO)this.sirenLFO.stop();}catch(e){} this.sirenOsc=null; } this.currentSirenType=null; }
            checkSirenUpdate(newType) { if(this.isMuted) { this.stopSiren(); return; } if(this.sirenOsc && this.currentSirenType!==newType) { this.stopSiren(); this.startSiren(newType); } else if(!this.sirenOsc) this.startSiren(newType); }
            playWarning() { if(this.isMuted) return; const t=this.ctx.currentTime; const o=this.ctx.createOscillator(); o.type='triangle'; o.frequency.setValueAtTime(600,t); const g=this.ctx.createGain(); g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.15,t+0.05); g.gain.setValueAtTime(0.15,t+0.3); g.gain.linearRampToValueAtTime(0,t+0.35); g.gain.linearRampToValueAtTime(0.15,t+0.7); g.gain.setValueAtTime(0.15,t+0.95); g.gain.linearRampToValueAtTime(0,t+1.0); g.gain.linearRampToValueAtTime(0.15,t+1.35); g.gain.setValueAtTime(0.15,t+1.6); g.gain.linearRampToValueAtTime(0,t+1.65); o.connect(g); g.connect(this.masterGain); o.start(t); o.stop(t+1.7); }
            playRocket() { if(this.isMuted) return; const t=this.ctx.currentTime; const noise=this.ctx.createBufferSource(); noise.buffer=this.createNoiseBuffer(); const f=this.ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.setValueAtTime(800,t); f.frequency.exponentialRampToValueAtTime(100,t+1.0); const g=this.ctx.createGain(); g.gain.setValueAtTime(0.4,t); g.gain.exponentialRampToValueAtTime(0.01,t+1.0); noise.connect(f); f.connect(g); g.connect(this.masterGain); noise.start(t); }
            playTrainBell() { if(this.isMuted) return; const t=this.ctx.currentTime; const o=this.ctx.createOscillator(); o.type='square'; o.frequency.setValueAtTime(800,t); const g=this.ctx.createGain(); g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.1,t+0.05); g.gain.linearRampToValueAtTime(0,t+0.2); o.connect(g); g.connect(this.masterGain); o.start(t); o.stop(t+0.3); }
            playTrainRumble() { if(this.isMuted) return; const t=this.ctx.currentTime; const bufferSize=this.ctx.sampleRate*2.0; const buffer=this.ctx.createBuffer(1,bufferSize,this.ctx.sampleRate); const data=buffer.getChannelData(0); for(let i=0;i<bufferSize;i++)data[i]=Math.random()*2-1; const noise=this.ctx.createBufferSource(); noise.buffer=buffer; const filter=this.ctx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.setValueAtTime(120,t); const gain=this.ctx.createGain(); gain.gain.setValueAtTime(0,t); gain.gain.linearRampToValueAtTime(0.8,t+0.5); gain.gain.setValueAtTime(0.8,t+1.5); gain.gain.linearRampToValueAtTime(0,t+2.0); noise.connect(filter); filter.connect(gain); gain.connect(this.masterGain); noise.start(t); }
            
            startEvilTheme() { if(this.isMuted||this.evilInterval)return; this.stopSiren(); let n=0; const p=()=>{ if(this.isMuted)return; const f=n%2===0?73.42:77.78; this.playEvilNote(f); n++; }; p(); this.evilInterval=setInterval(p,800); }
            stopEvilTheme() { if(this.evilInterval){ clearInterval(this.evilInterval); this.evilInterval=null; } }
            playEvilNote(f) { const t=this.ctx.currentTime; const o=this.ctx.createOscillator(); o.type='sawtooth'; o.frequency.setValueAtTime(f,t); const fl=this.ctx.createBiquadFilter(); fl.type='lowpass'; fl.frequency.value=200; const g=this.ctx.createGain(); g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.4,t+0.1); g.gain.exponentialRampToValueAtTime(0.01,t+0.6); o.connect(fl); fl.connect(g); g.connect(this.masterGain); o.start(t); o.stop(t+0.7); }
            
            createNoiseBuffer() { const b = this.ctx.createBuffer(1, this.ctx.sampleRate*1.5, this.ctx.sampleRate); const d = b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1; return b; }
            stopAll() { this.stopSiren(); this.stopEvilTheme(); if(this.ctx.state==='running') this.ctx.suspend(); }
        }
        const synth = new PacmanSynth();

        function toggleMute() { const isMuted = synth.toggleMute(); document.getElementById('mute-btn').innerText = isMuted ? 'üîá' : 'üîä'; canvas.focus(); }
        function uiClick() { synth.resume(); synth.playClick(); }
        function enterMenu() { synth.resume(); synth.playClick(); document.getElementById('intro-screen').classList.remove('visible'); document.getElementById('menu-screen').classList.add('visible'); }
        function backToIntro() { document.getElementById('menu-screen').classList.remove('visible'); document.getElementById('intro-screen').classList.add('visible'); synth.stopSiren(); }
        function getNick() { return document.getElementById('nickname').value.trim() || "PLAYER"; }
        function saveNick() { localStorage.setItem('pac_royale_nickname', getNick()); }
        function createLobby() { saveNick(); socket.emit('createLobby', { nickname: getNick() }); }
        function joinLobby() { const c = document.getElementById('lobby-code-input').value.trim(); if(!c) { showErr('ENTER CODE'); return; } saveNick(); socket.emit('joinLobby', { code: c, nickname: getNick() }); }
        function startGame() { socket.emit('startGame'); }
        function showErr(msg) { document.getElementById('menu-error').innerText = msg; }
        function copyLink() { navigator.clipboard.writeText(window.location.origin + "/?code=" + document.getElementById('lobby-code-display').innerText.split(': ')[1]); alert("Link copied!"); }
        function toggleBoard() { const el = document.getElementById('board-screen'), intro = document.getElementById('intro-screen'); if(el.classList.contains('visible')) { el.classList.remove('visible'); intro.classList.add('visible'); } else { intro.classList.remove('visible'); el.classList.add('visible'); renderBoard(); } }
        function renderBoard() { const t = document.getElementById('board-table'); t.innerHTML = '<tr><th>RANK</th><th>NAME</th><th>SCORE</th></tr>'; if(leaderboardData && leaderboardData.length > 0) leaderboardData.forEach((r,i) => t.innerHTML += `<tr><td style="color:${i===0?'#FFFF00':'#ccc'}">${i+1}ST</td><td>${r.name}</td><td>${r.score}</td></tr>`); else t.innerHTML += '<tr><td colspan="3">NO RECORDS YET</td></tr>'; }
        
        function renderLobbySlots(players) { 
            for(let i=0; i<4; i++) { const s=document.getElementById(`slot-${i}`); s.className='lobby-slot'; s.innerHTML=`<div class="slot-label">PLAYER ${i+1}</div><div class="waiting-anim">WAITING...</div>`; } 
            players.forEach(p => { const s=document.getElementById(`slot-${p.colorIdx}`); if(s) { s.classList.add('filled'); s.innerHTML=`<div class="slot-label" style="color:${p.color}">PLAYER ${p.colorIdx+1}</div><div class="slot-pacman" style="--slot-color:${p.color};"></div><div class="slot-name">${p.name}</div>`; } }); 
            document.querySelectorAll('.color-swatch').forEach((el, idx) => { const myColor = PLAYER_COLORS[idx], taken = players.some(p => p.color === myColor && p.id !== socket.id); if (taken) { el.classList.add('disabled'); el.onclick = null; } else { el.classList.remove('disabled'); el.onclick = () => selectColor(idx); } });
        }
        
        function selectColor(index) { socket.emit('changeColor', index); uiClick(); }
        function closeGameOver() { document.getElementById('game-over').classList.remove('visible'); document.getElementById('spectator-menu-btn').style.display = 'block'; }
        function reopenGameOver() { document.getElementById('game-over').classList.add('visible'); document.getElementById('spectator-menu-btn').style.display = 'none'; }
        function hideSpectatorBtn() { document.getElementById('spectator-menu-btn').style.display = 'none'; }
        function returnToLobby() { socket.emit('returnToLobby'); uiClick(); }

        socket.on('lobbyUpdate', d => { 
            hideSpectatorBtn(); 
            document.getElementById('ui-layer').style.display = 'none'; 
            document.getElementById('game-over').classList.remove('visible'); 
            document.getElementById('menu-screen').classList.remove('visible'); 
            document.getElementById('lobby-screen').classList.add('visible'); 
            canvas.style.display = 'none'; 
            document.getElementById('mute-btn').style.display = 'none'; 
            document.getElementById('lobby-code-display').innerText = `CODE: ${d.roomId}`; 
            renderLobbySlots(d.players); 
            if(socket.id === d.hostId) { document.getElementById('start-game-btn').style.display = 'block'; document.getElementById('waiting-msg').style.display = 'none'; } 
            else { document.getElementById('start-game-btn').style.display = 'none'; document.getElementById('waiting-msg').style.display = 'block'; } 
        });
        
        socket.on('errorMsg', msg => showErr(msg));
        socket.on('roomClosed', () => { hideSpectatorBtn(); document.querySelectorAll('.screen').forEach(s => s.classList.remove('visible')); document.getElementById('host-left-screen').classList.add('visible'); synth.stopSiren(); });
        
        socket.on('gameStarted', () => { 
            prevScore = 0; // <--- FIX: –°–±—Ä–æ—Å —Å—á–µ—Ç–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏–≥—Ä—ã
            visualPlayers = {}; 
            hideSpectatorBtn(); document.querySelectorAll('.screen').forEach(s => s.classList.remove('visible')); 
            document.getElementById('ui-layer').style.display = 'flex';
            canvas.style.display = 'block'; document.getElementById('mute-btn').style.display = 'flex'; 
            isJoined = true; isSpectating = false; synth.resume(); synth.playIntro(); 
            setTimeout(() => { if(isJoined) synth.startSiren('normal'); }, 4000); 
            requestAnimationFrame(renderLoop); 
        });

        socket.on('fullMap', (rows) => { localRows = rows; const keys = Object.keys(localRows).map(Number).sort((a,b)=>a-b); if (keys.length > 100) { for(let i=0; i<keys.length-80; i++) delete localRows[keys[i]]; } });
        socket.on('sfx', t => { 
            if(!isJoined && !isSpectating) return; 
            if(t==='waka') synth.playWaka(); 
            else if(t==='eatGhost'||t==='eatFruit') synth.playEat(); 
            else if(t==='death') synth.playDeath(); 
            else if(t==='power') synth.startSiren('power'); 
            else if(t==='warning') synth.playWarning(); 
            else if(t==='rocket') synth.playRocket(); 
            else if(t==='trainBell') synth.playTrainBell();
            else if(t==='trainRumble') synth.playTrainRumble();
        });
        socket.on('popup', p => popups.push({x: p.x, y: p.y, text: p.text, life: 60, color: p.color}));
        
        function updateLeaderboardHTML(playersMap) {
            const t = document.getElementById('match-results-container');
            const ps = Object.values(playersMap).sort((a, b) => b.score - a.score);
            let h = '<table class="match-leaderboard">';
            ps.forEach((p, i) => { let tr=''; if(i===0) tr='üèÜ'; else if(i===1) tr='ü•à'; else if(i===2) tr='ü•â'; let cl='leader-row'; if(i===0) cl+=' first-place'; h+=`<tr class="${cl}"><td>${tr}#${i+1}</td><td style="color:${p.color}">${p.name}${p.alive?'':' (DEAD)'}</td><td>${p.score}</td></tr>`; });
            h+='</table>'; t.innerHTML=h;
            const b = document.querySelector('.btn-spectate'); if(b) b.disabled = !ps.some(p=>p.alive);
        }

        // --- HELPER TO GET ITEM SVG ---
        function getItemSVG(type) {
            if (type == 4) return `<svg viewBox="0 0 30 30" class="icon-svg"><circle cx="15" cy="18" r="6" fill="#ff0000"/><path d="M15,18 Q20,10 22,8" stroke="#00ff00" stroke-width="2" fill="none"/></svg>`;
            if (type == 7) return `<svg viewBox="0 0 30 30" class="icon-svg"><path d="M8,10 L22,10 L15,22 Z" fill="#de0000"/><path d="M8,10 L15,5 L22,10" fill="#00ff00"/><rect x="12" y="12" width="2" height="2" fill="#fff"/><rect x="16" y="14" width="2" height="2" fill="#fff"/></svg>`;
            if (type == 8) return `<svg viewBox="0 0 30 30" class="icon-svg"><circle cx="15" cy="16" r="7" fill="#ffae00"/><path d="M15,9 Q18,9 20,12 L15,12 Z" fill="#00ff00"/></svg>`;
            if (type == 9) return `<svg viewBox="0 0 30 30" class="icon-svg"><circle cx="15" cy="16" r="7" fill="#ff0000"/><path d="M15,9 L15,6" stroke="#00ff00" stroke-width="2"/></svg>`;
            if (type == 10) return `<svg viewBox="0 0 30 30" class="icon-svg"><ellipse cx="15" cy="16" rx="7" ry="9" fill="#00ff00"/><ellipse cx="13" cy="14" rx="2" ry="4" transform="rotate(-10 13 14)" fill="#ccffcc"/></svg>`;
            if (type == 11) return `<svg viewBox="0 0 30 30" class="icon-svg"><path d="M15,8 L22,18 L8,18 Z" fill="#ffff00"/><path d="M8,8 L8,18 L15,22 L22,18 L22,8 Z" fill="#0000ff"/></svg>`;
            if (type == 12) return `<svg viewBox="0 0 30 30" class="icon-svg"><path d="M15,8 Q22,8 22,20 L8,20 Q8,8 15,8 Z" fill="#ffff00"/><ellipse cx="15" cy="18" rx="2" ry="4" fill="#000"/></svg>`;
            if (type == 13) return `<svg viewBox="0 0 30 30" class="icon-svg"><path d="M15,8 L15,22" stroke="#00ffff" stroke-width="3"/><circle cx="15" cy="8" r="4" stroke="#00ffff" stroke-width="1" fill="none"/><path d="M15,16 L20,16 M15,20 L20,20" stroke="#00ffff" stroke-width="1"/></svg>`;
            return "";
        }

        socket.on('gameOver', data => { 
            document.getElementById('game-over').classList.add('visible'); document.getElementById('final-score').innerText = "YOUR SCORE: " + data.score; 
            isJoined = false; isSpectating = true; hideSpectatorBtn(); document.getElementById('mute-btn').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'none';
            
            const ghostSVG = `<svg viewBox="0 0 30 30" class="icon-svg"><path d="M4,15 A11,11 0 0 1 26,15 L26,26 L22,22 L18,26 L14,22 L10,26 L4,22 Z" fill="#1919A6"/><g fill="#FFB8FF"><rect x="9" y="13" width="2" height="2"/><rect x="17" y="13" width="2" height="2"/><path d="M8,20 L12,17 L16,20 L20,17 L24,20" stroke="#FFB8FF" stroke-width="1" fill="none"/></g></svg>`;
            const pacSVG = `<svg viewBox="0 0 30 30" class="icon-svg"><path d="M15,15 L25,10 A12,12 0 1 0 25,20 Z" fill="#FFFF00"/></svg>`;
            const evilSVG = `<svg viewBox="0 0 30 30" class="icon-svg"><circle cx="15" cy="15" r="10" fill="#FF0000"/><circle cx="11" cy="13" r="2" fill="white"/><circle cx="19" cy="13" r="2" fill="white"/><path d="M11,19 L19,19" stroke="black" stroke-width="1"/></svg>`;
            
            let statsHtml = "";
            if (data.stats.ghosts > 0) statsHtml += `<div class="stat-item">${ghostSVG}x${data.stats.ghosts}</div>`;
            if (data.stats.players > 0) statsHtml += `<div class="stat-item">${pacSVG}x${data.stats.players}</div>`;
            if (data.stats.evil > 0) statsHtml += `<div class="stat-item">${evilSVG}x${data.stats.evil}</div>`;

            if (data.items) {
                const keys = Object.keys(data.items).sort((a,b) => parseInt(a) - parseInt(b));
                for (const key of keys) {
                    const count = data.items[key];
                    if (count > 0) {
                        const svg = getItemSVG(key);
                        if (svg) {
                            statsHtml += `<div class="stat-item">${svg}x${count}</div>`;
                        }
                    }
                }
            }

            document.getElementById('match-stats-container').innerHTML = statsHtml;
            
            const btnState = data.allDead ? '' : 'disabled style="background:#555; cursor:not-allowed;"';
            const btnText = data.allDead ? 'PLAY AGAIN' : 'WAITING...';
            document.getElementById('go-buttons').innerHTML = `<button class="btn-spectate" onclick="closeGameOver(); uiClick()" ${!data.leaderboard.some(p=>p.alive)?'disabled':''}>SPECTATE</button><button id="btn-replay" class="btn-play-again" onclick="returnToLobby()" ${btnState}>${btnText}</button><button class="btn-main-menu" onclick="location.reload()">MAIN MENU</button>`;
            const po={}; data.leaderboard.forEach(p=>po[p.name]=p); updateLeaderboardHTML(po); synth.stopSiren(); 
        });

        socket.on('matchEnded', () => { const btn = document.getElementById('btn-replay'); if(btn) { btn.disabled = false; btn.style.background = '#00FF00'; btn.style.cursor = 'pointer'; btn.innerText = 'PLAY AGAIN'; } synth.stopAll(); });
        socket.on('leaderboardUpdate', d => leaderboardData = d);
        
        let lastInputTime = 0;
        function sendInput(d, e) {
            if(e) e.preventDefault();
            if(!isJoined) return;
            const now = Date.now();
            if (now - lastInputTime < 50) return; 
            lastInputTime = now;
            socket.emit('input', d);
        }

        document.addEventListener('keydown', e => { 
            let d=null; 
            if(e.code==='ArrowUp'||e.code==='KeyW') d={x:0,y:-1}; 
            if(e.code==='ArrowDown'||e.code==='KeyS') d={x:0,y:1}; 
            if(e.code==='ArrowLeft'||e.code==='KeyA') d={x:-1,y:0}; 
            if(e.code==='ArrowRight'||e.code==='KeyD') d={x:1,y:0}; 
            if(d) sendInput(d); 
        });

        socket.on('state', s => {
            if(s.changes) { Object.assign(localRows, s.changes.newRows); s.changes.removedDots.forEach(pt => { if(localRows[pt.y]) localRows[pt.y][pt.x] = 0; }); const cy = Math.floor(s.camY / TILE_SIZE); for(let k in localRows) { if(parseInt(k) > cy + 50) delete localRows[k]; } }
            if(isSpectating && s.players) updateLeaderboardHTML(s.players);
            currState = s;
        });

        let visualPlayers = {}, visualGhosts = [], visualTrainGhosts = [], visualCamY = 0;
        let lastTime = Date.now();
        function lerp(start, end, t) { return start * (1 - t) + end * t; }

        function renderLoop() {
            if(!isJoined && !isSpectating) return;
            requestAnimationFrame(renderLoop);
            if(!currState) return;

            const now = Date.now();
            const dt = Math.min((now - lastTime) / 1000, 0.1); 
            lastTime = now;
            const s = currState;

            if (visualCamY === 0 && s.camY !== undefined) visualCamY = s.camY;
            if (s.camY !== undefined) visualCamY = lerp(visualCamY, s.camY, 5 * dt);

            let shakeX = 0, shakeY = 0;
            let isShaking = s.sbt > 0;
            if (s.surgeHeight > 0) isShaking = true;
            if (s.train && s.train.state === 'CROSSING') isShaking = true;

            if (document.getElementById('game-over').classList.contains('visible')) {
                isShaking = false;
            }

            if (isShaking) { shakeX = (Math.random() - 0.5) * 4; shakeY = (Math.random() - 0.5) * 4; }

            const cdEl = document.getElementById('countdown-display');
            if (s.cd > 0) { cdEl.style.display = 'block'; cdEl.innerText = Math.ceil(s.cd); } else if (s.cd > -1) { cdEl.style.display = 'block'; cdEl.innerText = "GO!"; } else { cdEl.style.display = 'none'; }
            
            let anyEvil = false;
            if (s.players) { anyEvil = Object.values(s.players).some(p => p.pvpTimer > 0); }

            if (anyEvil) { synth.startEvilTheme(); } else { synth.stopEvilTheme(); if (now - (s.st || 0) > 4000 || s.cd < 0) { if(s.ft > 0) synth.checkSirenUpdate('power'); else synth.checkSirenUpdate('normal'); } }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const startRow = Math.floor(visualCamY / TILE_SIZE) - 2;
            const endRow = startRow + (canvas.height / TILE_SIZE) + 4;

            ctx.save();
            ctx.translate(shakeX, shakeY); 

            for (let y = startRow; y <= endRow; y++) {
                if (!localRows[y]) continue;
                const sy = (y * TILE_SIZE - visualCamY) | 0; 
                for (let x = 0; x < 20; x++) {
                    const t = localRows[y][x], sx = x * TILE_SIZE;
                    if (t === 0) continue; 
                    if (t === 1) {
                        let wc = '#1919A6'; if (s.sbt > 0 && Math.floor(now / 150) % 2 === 0) wc = '#FFFF00';
                        ctx.fillStyle = wc; ctx.fillRect(sx, sy, TILE_SIZE, TILE_SIZE);
                        ctx.fillStyle = 'black'; ctx.fillRect(sx + 4, sy + 4, TILE_SIZE - 8, TILE_SIZE - 8);
                        if (x < 19 && localRows[y][x+1] === 1) ctx.fillRect(sx + TILE_SIZE - 4, sy + 4, 8, TILE_SIZE - 8);
                        if (x > 0 && localRows[y][x-1] === 1) ctx.fillRect(sx - 4, sy + 4, 8, TILE_SIZE - 8);
                        if (localRows[y+1] && localRows[y+1][x] === 1) ctx.fillRect(sx + 4, sy + TILE_SIZE - 4, TILE_SIZE - 8, 8);
                        if (localRows[y-1] && localRows[y-1][x] === 1) ctx.fillRect(sx + 4, sy - 4, TILE_SIZE - 8, 8);
                    } else if (t === 2) { ctx.fillStyle = '#ffb8ae'; ctx.fillRect(sx+13, sy+13, 4, 4);
                    } else if (t === 3) { ctx.fillStyle = (now%400 < 200) ? '#fff' : '#ffb8ae'; ctx.beginPath(); ctx.arc(sx+15, sy+15, 8, 0, Math.PI*2); ctx.fill();
                    } else if (t === 4) { drawItem(ctx, t, sx, sy); }
                    else if (t === 5) { drawItem(ctx, t, sx, sy); }
                    else if (t === 6) { drawItem(ctx, t, sx, sy); }
                    else if (t >= 7 && t <= 13) { drawItem(ctx, t, sx, sy); }
                }
            }

            if (s.warnings) s.warnings.forEach(w => drawWarning(ctx, w.x, w.y - visualCamY));
            if (s.rockets) s.rockets.forEach(r => drawGhost(ctx, r.x, r.y - visualCamY, r.color, 0, -1, 0)); 
            
            if (s.train && s.train.state !== 'OFF') {
                if (s.train.ghosts && s.train.ghosts.length > 0) {
                    if(visualTrainGhosts.length !== s.train.ghosts.length) visualTrainGhosts = s.train.ghosts.map(g => ({x: g.x, y: g.y}));
                    s.train.ghosts.forEach((g, i) => {
                        if(!visualTrainGhosts[i]) visualTrainGhosts[i] = {x: g.x, y: g.y};
                        visualTrainGhosts[i].x = lerp(visualTrainGhosts[i].x, g.x, 5 * dt);
                        visualTrainGhosts[i].y = g.y; 
                        drawGhost(ctx, visualTrainGhosts[i].x, visualTrainGhosts[i].y - visualCamY, g.color, g.vx, 0, 0);
                    });
                }

                if (s.train.targetY !== null && (s.train.state === 'YELLOW' || s.train.state === 'RED' || s.train.state === 'CROSSING')) {
                    drawWorldSignal(ctx, s.train.targetY - 60, visualCamY, s.train.state, now);
                }
            } else {
                visualTrainGhosts = [];
            }
            
            if(s.ghosts) {
                if(visualGhosts.length !== s.ghosts.length) visualGhosts = s.ghosts.map(g => ({x: g.x, y: g.y})); 
                s.ghosts.forEach((g, i) => {
                    if(!visualGhosts[i]) visualGhosts[i] = {x: g.x, y: g.y};
                    visualGhosts[i].x = lerp(visualGhosts[i].x, g.x, 5 * dt);
                    visualGhosts[i].y = lerp(visualGhosts[i].y, g.y, 5 * dt);
                    drawGhost(ctx, visualGhosts[i].x, visualGhosts[i].y - visualCamY, g.color, g.vx, g.vy, s.ft);
                });
            }

            for(let i=0; i<4; i++) document.getElementById(`p${i}`).classList.remove('active');
            for(let id in s.players) {
                const p = s.players[id];
                if(!visualPlayers[id]) visualPlayers[id] = {x: p.x, y: p.y};
                const panel = document.getElementById(`p${p.colorIdx}`);
                if(panel) { panel.style.setProperty('--p-color', p.color); panel.classList.add('active'); document.getElementById(`n${p.colorIdx}`).innerText = p.name; document.getElementById(`s${p.colorIdx}`).innerText = p.score; document.getElementById(`l${p.colorIdx}`).innerText = p.alive ? "‚ù§Ô∏è".repeat(p.lives) : "DEAD"; }
                
                // --- FIX: Logic for playing Waka sound ---
                if(p.id === socket.id) {
                    if (p.score < prevScore) prevScore = p.score;
                    if (p.score > prevScore) { 
                        synth.playWaka(); 
                        prevScore = p.score; 
                    }
                }
                
                if(!p.alive) continue;
                
                const dist = Math.sqrt((visualPlayers[id].x - p.x)**2 + (visualPlayers[id].y - p.y)**2);
                if (dist > 50) { visualPlayers[id].x = p.x; visualPlayers[id].y = p.y; } 
                else { visualPlayers[id].x = lerp(visualPlayers[id].x, p.x, 10 * dt); visualPlayers[id].y = lerp(visualPlayers[id].y, p.y, 10 * dt); }

                const ix = visualPlayers[id].x, iy = visualPlayers[id].y, sy = iy - visualCamY;
                if (p.deathTimer > 0) { const pr = 1 - (p.deathTimer / 60), sa = -Math.PI/2 + (pr * Math.PI), ea = -Math.PI/2 + (2*Math.PI - pr * Math.PI); ctx.fillStyle = p.color; ctx.beginPath(); ctx.moveTo(ix + 15, sy + 15); ctx.arc(ix + 15, sy + 15, 12, sa, ea); ctx.fill(); continue; }
                if(p.invulnTimer > 0 && now%200 < 100) continue;
                ctx.fillStyle = (p.pvpTimer > 0) ? '#FF0000' : p.color; 
                ctx.beginPath();
                if(p.vx > 0) lastAngles[id] = 0; else if(p.vy > 0) lastAngles[id] = Math.PI/2; else if(p.vx < 0) lastAngles[id] = Math.PI; else if(p.vy < 0) lastAngles[id] = -Math.PI/2;
                const ang = lastAngles[id] !== undefined ? lastAngles[id] : 0, m = 0.2 + (Math.sin(now/50)+1)/10;
                ctx.arc(ix+15, sy+15, 12, ang + m*Math.PI, ang + (2-m)*Math.PI); ctx.lineTo(ix+15, sy+15); ctx.fill();
                ctx.fillStyle = "white"; ctx.font = "8px 'Press Start 2P'"; ctx.textAlign="center"; ctx.fillText(p.name, ix+15, sy-5);
            }

            popups = popups.filter(p => p.life > 0);
            popups.forEach(p => { p.life--; p.y -= 1; ctx.fillStyle = p.color || '#00FFFF'; ctx.font = "10px 'Press Start 2P'"; ctx.fillText(p.text, p.x+15, p.y - visualCamY); });
            
            const ty = canvas.height - 40; if(s.cd > 0) deathZoneY = canvas.height + 100; else deathZoneY += (ty - deathZoneY) * 0.02; 
            const surgeHeight = s.surgeHeight || 0; const visualDeathY = deathZoneY - surgeHeight; const gc = ['#FF0000', '#FFB8FF', '#00FFFF', '#FFB852'];
            for (let gy = visualDeathY; gy < canvas.height + 60; gy += 30) {
                const rowIndex = Math.floor(gy / 30);
                for(let i=-1; i<22; i++) { const chaosX = Math.sin(now/200 + i + rowIndex) * 3; const chaosY = Math.cos(now/200 + i * 0.5 + rowIndex) * 3; const seed = (i * 137) + (rowIndex * 149); const rnd = Math.abs(Math.sin(seed) * 10000); const colorIndex = Math.floor(rnd) % 4; drawGhost(ctx, i*30 + chaosX, gy + chaosY, gc[colorIndex], 0, -1, 0); }
            }
            ctx.restore(); 
        }

        function drawItem(ctx, type, sx, sy) {
            if (type === 4) { // CHERRY
                ctx.fillStyle = '#ff0000'; ctx.beginPath(); ctx.arc(sx+15, sy+18, 6, 0, Math.PI*2); ctx.fill(); 
                ctx.strokeStyle = '#00ff00'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(sx+15, sy+18); ctx.quadraticCurveTo(sx+20, sy+10, sx+22, sy+8); ctx.stroke();
            } else if (type === 5) { // EVIL
                ctx.fillStyle = '#FF0000'; ctx.beginPath(); ctx.arc(sx+15, sy+15, 8, 0, Math.PI*2); ctx.fill(); 
                ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(sx+12, sy+13, 2, 0, Math.PI*2); ctx.arc(sx+18, sy+13, 2, 0, Math.PI*2); ctx.fill(); 
                ctx.strokeStyle = 'black'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(sx+12, sy+18); ctx.lineTo(sx+18, sy+18); ctx.stroke();
            } else if (type === 6) { // HEART
                ctx.fillStyle = '#ff3333'; ctx.beginPath(); ctx.moveTo(sx+15, sy+10); ctx.bezierCurveTo(sx+15, sy+8, sx+12, sy+5, sx+8, sy+5); ctx.bezierCurveTo(sx+2, sy+5, sx+2, sy+14, sx+15, sy+22); ctx.bezierCurveTo(sx+28, sy+14, sx+28, sy+5, sx+22, sy+5); ctx.bezierCurveTo(sx+18, sy+5, sx+15, sy+8, sx+15, sy+10); ctx.fill(); 
            } else if (type === 7) { // STRAWBERRY
                ctx.fillStyle = '#de0000'; ctx.beginPath(); ctx.moveTo(sx+8, sy+10); ctx.lineTo(sx+22, sy+10); ctx.lineTo(sx+15, sy+22); ctx.fill();
                ctx.fillStyle = '#00ff00'; ctx.beginPath(); ctx.moveTo(sx+8, sy+10); ctx.lineTo(sx+15, sy+5); ctx.lineTo(sx+22, sy+10); ctx.fill();
                ctx.fillStyle = '#fff'; ctx.fillRect(sx+12, sy+12, 2, 2); ctx.fillRect(sx+16, sy+14, 2, 2);
            } else if (type === 8) { // ORANGE
                ctx.fillStyle = '#ffae00'; ctx.beginPath(); ctx.arc(sx+15, sy+16, 7, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#00ff00'; ctx.beginPath(); ctx.moveTo(sx+15, sy+9); ctx.quadraticCurveTo(sx+18, sy+9, sx+20, sy+12); ctx.lineTo(sx+15, sy+12); ctx.fill();
            } else if (type === 9) { // APPLE
                ctx.fillStyle = '#ff0000'; ctx.beginPath(); ctx.arc(sx+15, sy+16, 7, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = '#00ff00'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(sx+15, sy+9); ctx.lineTo(sx+15, sy+6); ctx.stroke();
            } else if (type === 10) { // MELON
                ctx.fillStyle = '#00ff00'; ctx.beginPath(); ctx.ellipse(sx+15, sy+16, 7, 9, 0, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#ccffcc'; ctx.beginPath(); ctx.ellipse(sx+13, sy+14, 2, 4, -0.2, 0, Math.PI*2); ctx.fill();
            } else if (type === 11) { // GALAXIAN
                ctx.fillStyle = '#ffff00'; ctx.beginPath(); ctx.moveTo(sx+15, sy+8); ctx.lineTo(sx+22, sy+18); ctx.lineTo(sx+8, sy+18); ctx.fill();
                ctx.fillStyle = '#0000ff'; ctx.beginPath(); ctx.moveTo(sx+8, sy+8); ctx.lineTo(sx+8, sy+18); ctx.lineTo(sx+15, sy+22); ctx.lineTo(sx+22, sy+18); ctx.lineTo(sx+22, sy+8); ctx.fill();
            } else if (type === 12) { // BELL
                ctx.fillStyle = '#ffff00'; ctx.beginPath(); ctx.moveTo(sx+15, sy+8); ctx.quadraticCurveTo(sx+22, sy+8, sx+22, sy+20); ctx.lineTo(sx+8, sy+20); ctx.quadraticCurveTo(sx+8, sy+8, sx+15, sy+8); ctx.fill();
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.ellipse(sx+15, sy+18, 2, 4, 0, 0, Math.PI*2); ctx.fill();
            } else if (type === 13) { // KEY
                ctx.strokeStyle = '#00ffff'; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(sx+15, sy+8); ctx.lineTo(sx+15, sy+22); ctx.stroke();
                ctx.beginPath(); ctx.arc(sx+15, sy+8, 4, 0, Math.PI*2); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(sx+15, sy+16); ctx.lineTo(sx+20, sy+16); ctx.moveTo(sx+15, sy+20); ctx.lineTo(sx+20, sy+20); ctx.stroke();
            }
        }

        function drawWorldSignal(ctx, worldY, camY, state, time) {
            const centerX = canvas.width / 2;
            const drawY = worldY - camY;
            const w = 80; const h = 30; 
            ctx.fillStyle = '#000'; ctx.fillRect(centerX - w/2, drawY, w, h);
            ctx.lineWidth = 4; ctx.strokeStyle = '#1919A6'; ctx.strokeRect(centerX - w/2, drawY, w, h);
            const blink = Math.floor(time / 150) % 2 === 0;
            const cy = drawY + h/2;
            ctx.beginPath(); ctx.arc(centerX - 20, cy, 10, 0, Math.PI*2);
            if (state === 'YELLOW' && blink) { ctx.fillStyle = '#FFFF00'; ctx.shadowBlur = 10; ctx.shadowColor = '#FFFF00'; } else { ctx.fillStyle = '#222'; ctx.shadowBlur = 0; }
            ctx.fill(); ctx.shadowBlur = 0;
            ctx.beginPath(); ctx.arc(centerX + 20, cy, 10, 0, Math.PI*2);
            if ((state === 'RED' || state === 'CROSSING') && blink) { ctx.fillStyle = '#FF0000'; ctx.shadowBlur = 10; ctx.shadowColor = '#FF0000'; } else { ctx.fillStyle = '#222'; ctx.shadowBlur = 0; }
            ctx.fill(); ctx.shadowBlur = 0;
        }

        function drawWarning(ctx, x, y) { if (Math.floor(Date.now() / 150) % 2 === 0) return; const cx = x + 15, cy = y + 15; ctx.fillStyle = '#FF0000'; ctx.beginPath(); ctx.moveTo(cx, cy - 12); ctx.lineTo(cx + 12, cy + 10); ctx.lineTo(cx - 12, cy + 10); ctx.fill(); ctx.fillStyle = '#FFFF00'; ctx.fillRect(cx - 2, cy - 5, 4, 9); ctx.fillRect(cx - 2, cy + 6, 4, 2); }
        function drawGhost(ctx, x, y, color, vx, vy, ft) {
            const cx = x + TILE_SIZE/2, cy = y + TILE_SIZE/2; let bc = color, isScared = ft > 0;
            if (isScared) bc = (ft < 120 && Math.floor(Date.now() / 200) % 2 === 0) ? '#FFFFFF' : '#1919A6';
            ctx.fillStyle = bc; ctx.beginPath(); ctx.arc(cx, cy - 2, 13, Math.PI, 0); ctx.lineTo(cx + 13, cy + 13);
            if (isScared) { const ww = 6; for (let i = 1; i <= 4; i++) { ctx.lineTo(cx + 13 - ww * i + ww/2, cy + 10); ctx.lineTo(cx + 13 - ww * i, cy + 13); } } else { for(let i=1; i<=3; i++) { ctx.lineTo(cx + 13 - 26/3*i + 26/6, cy + 10); ctx.lineTo(cx + 13 - 26/3*i, cy + 13); } }
            ctx.lineTo(cx - 13, cy - 2); ctx.fill();
            if (isScared) { const fc = (bc === '#FFFFFF') ? '#FF0000' : '#FFB8FF'; ctx.fillStyle = fc; ctx.fillRect(cx - 5, cy - 2, 2, 2); ctx.fillRect(cx + 3, cy - 2, 2, 2); ctx.strokeStyle = fc; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(cx - 10, cy + 5); ctx.lineTo(cx - 6, cy + 2); ctx.lineTo(cx - 2, cy + 5); ctx.lineTo(cx + 2, cy + 2); ctx.lineTo(cx + 6, cy + 5); ctx.lineTo(cx + 10, cy + 2); ctx.stroke(); } 
            else { 
                let px = vx > 0 ? 2 : (vx < 0 ? -2 : 0);
                let py = vy > 0 ? 2 : (vy < 0 ? -2 : 0); 
                ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(cx - 4, cy - 4, 4, 0, Math.PI * 2); ctx.arc(cx + 4, cy - 4, 4, 0, Math.PI * 2); ctx.fill(); ctx.fillStyle = 'blue'; ctx.beginPath(); ctx.arc(cx - 4 + px, cy - 4 + py, 2, 0, Math.PI * 2); ctx.arc(cx + 4 + px, cy - 4 + py, 2, 0, Math.PI * 2); ctx.fill(); 
            }
        }
    </script>
</body>
</html>